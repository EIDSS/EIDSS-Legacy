<?xml version="1.0" encoding="utf-8" ?>
<object name="HumanCaseDeduplicationListItem"
        connection="EidssConnectionString"
        generator="ObjectGenerator.xslt"
        xmlns="urn:schemas-bv:objectmodel">

	<storage>
		<get name="fn_Organization_SelectList" type="fnlist" />
		<count name="spOrganization_SelectCount"/>
	</storage>

	<tables>
		<table name="OrganizationListItem">
      <properties auditObject="daoOrganization" auditTable="tlbOffice" permissionObject="Organization">
        <lookupcache>
          <item name="Organization"/>
        </lookupcache>
      </properties>
      <help win="Organisations"/>
      <extfilters>
				<filter>
					<join>
						INNER JOIN fnInstitution(@LangID)
						ON fn_Organization_SelectList.idfInstitution = fnInstitution.idfOffice
						INNER JOIN tlbGeoLocationShared geo
						ON fnInstitution.idfLocation = geo.idfGeoLocationShared
					</join>
					<where>
						<!--<expr param="name" value="1=1"/>-->
						<expr param="idfsRegion" value="geo.idfsRegion {0} @idfsRegion"/>
						<expr param="idfsRayon" value="geo.idfsRayon {0} @idfsRayon"/>
						<expr param="idfsSettlement" value="geo.idfsSettlement {0} @idfsSettlement"/>
						<expr param="blnForeignAddress" value="(isnull(@blnForeignAddress,0) = 0 or geo.blnForeignAddress {0} @blnForeignAddress)"/>
					</where>
				</filter>
			</extfilters>
			<searchpanel>
				<item name="strOrganizationID" editor="Text" labelId="strOrganizationID" default="c => String.Empty"/>
				<item name="name" editor="Text" labelId="Abbreviation" default="c => String.Empty"/>
				<item name="FullName" editor="Text" labelId="Organization.Name" default="c => String.Empty"/>
        <item name="intHACode" editor="Lookup" labelId="strOrganizationHACode" multiple="true" bitmask="true"
             lookupName="HACodeLookup" lookupType="HACodeLookup" lookupText="c.CodeName" lookupValue="c.intHACode"/>
        <item name="blnForeignAddress" editor="Flag" isParam="true" labelId="lblShowForeignOrganization" dependent="idfsRegion"/>
        <item name="idfsRegion" editor="Lookup" labelId="idfsRegion" isParam="true" dependent="idfsRayon"
					  lookupName="RegionLookup" lookupType="RegionLookup" lookupText="c.strRegionName" lookupValue="c.idfsRegion"
					  defaultoper="="/>
				<item name="idfsRayon" editor="Lookup" labelId="idfsRayon" isParam="true" dependent="idfsSettlement"
					  lookupName="RayonLookup" lookupType="RayonLookup" lookupText="c.strRayonName" lookupValue="c.idfsRayon"/>
				<item name="idfsSettlement" editor="Lookup" labelId="Settlement" isParam="true"
					  lookupName="SettlementLookup" lookupType="SettlementLookup" lookupText="c.strSettlementName" lookupValue="c.idfsSettlement"/>

      </searchpanel>

			<grid>
				<item name="idfInstitution" visible="false" key="true" />
				<item name="name"  defaultSort="Ascending"/>
				<item name="FullName" />
				<item name="strOrganizationID" />
				<item name="Address"/>
			</grid>

			<labels>
				<item name="FullName" labelId="Organization.Name"/>
        <item name="name" labelId="Abbreviation"/>
        <item name="strOrganizationID" labelId="strOrganizationID"/>
        <item name="Address" labelId="Organization.Address"/>
			</labels>

      <fields>
				<storage name="idfsCountry" type="long?" />
				<storage name="idfsRegion" type="long?" />
				<storage name="idfsRayon" type="long?" />
				<storage name="idfsSettlement" type="long?" />
				<storage name="blnForeignAddress" type="bool?" />
			</fields>

      <readonly>
				<fields name="Region,idfsRegion" predicate="c => c.blnForeignAddress == true || c.idfsCountry == null || c.idfsCountry != eidss.model.Core.EidssSiteContext.Instance.CountryID" />
				<fields name="Rayon,idfsRayon" predicate="c => c.blnForeignAddress == true || c.idfsRegion == null" />
				<fields name="Settlement,idfsSettlement" predicate=" c => c.blnForeignAddress == true || c.idfsRayon == null" />
				<fields name="*" predicate="c => false" />
			</readonly>
			<lookups>
				<lookup name="Country" table="CountryLookup" source="idfsCountry" target="idfsCountry" />
				<lookup name="Region" table="RegionLookup" source="idfsRegion" target="idfsRegion">
					<params>
						<param name="CountryID" lambda="c => c.idfsCountry ?? 0" type="long" />
						<param name="ID" const="null" />
					</params>
				</lookup>
				<lookup name="Rayon" table="RayonLookup" source="idfsRayon" target="idfsRayon">
					<params>
						<param name="RegionID" lambda="c => c.idfsRegion ?? 0" type="long" />
						<param name="ID" const="null" />
					</params>
				</lookup>
				<lookup name="Settlement" table="SettlementLookup" source="idfsSettlement" target="idfsSettlement">
					<params>
						<param name="RayonID" lambda="c => c.idfsRayon ?? 0" type="long" />
						<param name="ID" const="null" />
					</params>
				</lookup>
        <lookup name="HACode" table="HACodeLookup" source="intHACode" target="intHACode" >
          <params>
            <param name="intHACode" lambda="c => (int)(Enums.HACode.Human | Enums.HACode.Avian | Enums.HACode.Livestock | Enums.HACode.Vector | Enums.HACode.Syndromic)" type="int" />
          </params>
        </lookup>
      </lookups>
      <storage>
        <delete name="spOrganization_Delete"/>
        <candelete name="spOrganization_CanDelete"/>
      </storage>

      <extenders>
				<created>
					<!-- set default country as current country of database -->
					<lambda_extender target="Country" type="CountryLookup" lambda='c => 
                                     c.CountryLookup.Where(a => a.idfsCountry == eidss.model.Core.EidssSiteContext.Instance.CountryID)
                                     .SingleOrDefault()'/>
          <lambda_extender target="Region" type="RegionLookup" lambda='c => 
                                     BaseSettings.DefaultRegionInSearch == true?
                                     c.RegionLookup.Where(a => a.idfsRegion == eidss.model.Core.EidssSiteContext.Instance.RegionID)
                                     .SingleOrDefault(): null'/>
        </created>
			</extenders>
			<handlers>
				<fieldhandler>
					<lambda_handler field="blnForeignAddress" target="Country" type="CountryLookup" lambda="c => c.blnForeignAddress == true? null:c.CountryLookup.Where(a => a.idfsCountry == eidss.model.Core.EidssSiteContext.Instance.CountryID).SingleOrDefault()"/>
					<lambda_handler field="idfsCountry" target="Region" type="RegionLookup" lambda="c => null"/>
					<lambda_handler field="idfsRegion" target="Rayon" type="RayonLookup" lambda="c => null"/>
					<lambda_handler field="idfsRayon" target="Settlement" type="SettlementLookup" lambda="c => null"/>
					<lookup_handler lookup="Region" field="idfsCountry" />
					<lookup_handler lookup="Rayon" field="idfsRegion" />
					<lookup_handler lookup="Settlement" field="idfsRayon" />
				</fieldhandler>
			</handlers>


      <actions child="Personnel">
        <standard>
          <remove type="Report"/>
        </standard>
        <action name="CreateWithHACode" type="Create">
          <run>
            <params>
              <param name="code" type="int"/>
            </params>
            <created>
              <!--lambda_extender type="HACodeLookup" target="HACode" lambda="o => o.HACodeLookup.FirstOrDefault(c => c.intHACode == code)"/-->
              <lambda_extender type="int" target="intHACode" lambda="o => code"/>
            </created>
          </run>
        </action>
      </actions>
      <!--actions child="Personnel">
				<action name="Report" type="Report" visible="false" />
			</actions-->

		</table>
	</tables>

</object>
