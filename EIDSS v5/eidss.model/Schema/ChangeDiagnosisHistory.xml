<?xml version="1.0" encoding="utf-8" ?>
<object name="ChangeDiagnosisHistory"
        connection="EidssConnectionString"
        generator="ObjectGenerator.xslt"
        xmlns="urn:schemas-bv:objectmodel">

    <storage>
        <get name="spChangeDiagnosisHistory_SelectDetail" type="detaillist" />
    </storage>

    <tables>
        <table name="ChangeDiagnosisHistory">
            <relations>
                <!-- idfHumanCase -->
                <!-- idfUserID -->
                <!-- idfPerson -->
            </relations>
            <lookups>
                <lookup name="PreviousDiagnosis" table="DiagnosisLookup" source="idfsPreviousDiagnosis" target="idfsDiagnosis">
                  <filters>
                    <filter predicate="c => ((c.intHACode &amp; (int)HACode.Human) != 0) || c.idfsDiagnosis == obj.idfsPreviousDiagnosis" />
                    <filter predicate="c => (c.idfsUsingType == (long)DiagnosisUsingTypeEnum.StandardCase) || c.idfsDiagnosis == obj.idfsPreviousDiagnosis" />
                  </filters>
                </lookup>
                <lookup name="CurrentDiagnosis" table="DiagnosisLookup" source="idfsCurrentDiagnosis" target="idfsDiagnosis">
                  <filters>
                    <filter predicate="c => ((c.intHACode &amp; (int)HACode.Human) != 0) || c.idfsDiagnosis == obj.idfsCurrentDiagnosis" />
                    <filter predicate="c => (c.idfsUsingType == (long)DiagnosisUsingTypeEnum.StandardCase) || c.idfsDiagnosis == obj.idfsCurrentDiagnosis" />
                  </filters>
                </lookup>
              <lookup name="ChangeDiagnosisReason" table="BaseReference" section="rftChangeDiagnosisReason" source="idfsChangeDiagnosisReason" target="idfsBaseReference" />

            </lookups>
            <storage>
                <post name="spChangeDiagnosisHistory_Post" />
            </storage>
            <extenders>
                <creating>
                    <scalar_extender target="idfChangeDiagnosisHistory" class="GetNewIDExtender" />
                    <value_extender target="datChangedDate" value="DateTime.Now"/>
                    <value_extender target="idfUserID" value="ModelUserContext.Instance == null ? 0 : (long)ModelUserContext.Instance.CurrentUser.ID"/>
                    <value_extender target="idfPerson" value="ModelUserContext.Instance == null ? 0 : (long)ModelUserContext.Instance.CurrentUser.EmployeeID"/>
                    <value_extender target="PersonName" value="ModelUserContext.Instance == null ? null : ModelUserContext.Instance.CurrentUser.FullName"/>
                    <value_extender target="Organization" value="ModelUserContext.Instance == null ? null : ModelUserContext.Instance.CurrentUser.Organization"/>
                </creating>
            </extenders>
            <handlers>
                <fieldhandler>
                    <lambda_handler field="idfsPreviousDiagnosis" target="PreviousDiagnosisName" type="string"
                                    lambda="c => c.PreviousDiagnosis == null ? null : c.PreviousDiagnosis.name"/>
                    <lambda_handler field="idfsCurrentDiagnosis" target="CurrentDiagnosisName" type="string"
                                    lambda="c => c.CurrentDiagnosis == null ? null : c.CurrentDiagnosis.name"/>
                </fieldhandler>
            </handlers>          
          <actions>
            <action name="Create" type="Create">
              <run>
                <params>
                  <param name="idfHumanCase" type="long" />
                  <param name="idfsPreviousDiagnosis" type="long?" />
                  <param name="idfsCurrentDiagnosis" type="long?" />
                </params>
                <creating>
                  <value_extender target="idfHumanCase" value="idfHumanCase" />
                </creating>
                <created>
                  <value_extender target="PreviousDiagnosis" value="obj.PreviousDiagnosisLookup.Where(a => a.idfsDiagnosis == idfsPreviousDiagnosis).SingleOrDefault()"/>
                  <value_extender target="CurrentDiagnosis" value="obj.CurrentDiagnosisLookup.Where(a => a.idfsDiagnosis == idfsCurrentDiagnosis).SingleOrDefault()"/>
                </created>
              </run>
            </action>
          </actions>
        </table>
    </tables>

</object>
