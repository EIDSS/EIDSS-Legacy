<?xml version="1.0" encoding="utf-8" ?>
<object name="FarmPanel"
        connection="EidssConnectionString"
        generator="ObjectGenerator.xslt"
        xmlns="urn:schemas-bv:objectmodel">

    <storage>
        <get />
    </storage>

    <tables>
        <table name="FarmRoot" hacodable="true">
            <properties permissionObject="VetCase"  auditObject="daoFarm" auditTable="tlbFarmActual"/>
          <labels>
            <item labelId="strFarmFullName" name="strFullName"/>
            <item labelId="idfFarmOwner" name="idfOwner"/>
          </labels>
          <fields>
            <storage name="_blnAllowFarmReload" type="bool"/>
          </fields>
          <readonly>
            <fields name="strFarmCode" predicate="c => true"/>
            <fields name="*" predicate="c => false"/>
          </readonly>
            <relations>
                <relation name="Location" table="GeoLocation" internal="false" type="link" source="idfFarmLocation" target="idfGeoLocation" />
                <relation name="Address" table="Address" internal="false" type="link" source="idfFarmAddress" target="idfGeoLocation" />
            </relations>
          <lookups>
          </lookups>
          
            <storage>
                <post name="spFarmPanel_Post" />
              <delete name="spFarm_Delete"/>
              <candelete name="spFarm_CanDelete"/>
            </storage>
            <postorder>
                <item name="Location" />
                <item name="Address" />
                <item name="this" />
            </postorder>
         
            <deleteorder>
                <!--<item name="FarmTree" />
                <item name="Address" />-->
                <item name="Location" />                
                <item name="this" />
            </deleteorder>
            <extenders>
                <creating>
                    <scalar_extender target="idfFarm" class="GetNewIDExtender" />
                    <lambda_extender target="strFarmCode" type="string" lambda='c => "(new farm)"' />
                    <create_extender target="Address" table="Address" class="ObjectCreateExtender" />
                    <lambda_extender target="Location" type="GeoLocation" lambda="c => LocationAccessor.CreateWithCountry(manager, c)" />
                  <value_extender target="_blnAllowFarmReload" value="true"/>
                  <scalar_extender target="idfObservation" class="GetNewIDExtender" />
                  <value_extender target="blnRootFarm" value="true"/>
                </creating>
              <created>
                <value_extender target="Address.blnGeoLocationShared" value="true"/>
                <value_extender target="Location.blnGeoLocationShared" value="true"/>
              </created>
              <loaded>
                <value_extender target="_blnAllowFarmReload" value="true"/>
                <lambda_extender target="Location" type="GeoLocation" lambda="c =>c.Location ?? LocationAccessor.CreateWithCountry(manager, c)" />
                <custom_extender>
                </custom_extender>
              </loaded>
                <posting>
                  <value_extender target="_blnAllowFarmReload" value="false"/>
                    <db_lambda_extender target="strFarmCode" type="string" lambda='(c,m) => 
                        c.strFarmCode != "(new farm)" 
                        ? c.strFarmCode 
                        : m.SetSpCommand("dbo.spGetNextNumber", (long)NumberingObjectEnum.Farm, DBNull.Value, DBNull.Value)
                        .ExecuteScalar&lt;string&gt;(ScalarSourceType.OutputParameter, "NextNumberValue")' />
                  <custom_extender>
                    <text>
                      obj.idfsAvianFarmType = null;
                      obj.idfsAvianProductionType = null;
                      obj.idfsIntendedUse = null;
                      obj.intBirdsPerBuilding = null;
                      obj.intBuidings = null;
                      
                      obj.idfsOwnershipStructure = null;
                      obj.idfsLivestockProductionType = null;
                      obj.idfsMovementPattern = null;
                      obj.idfsGrazingPattern = null;
                    </text>
                  </custom_extender>
                </posting>
              <posted>
                <value_extender target="_blnAllowFarmReload" value="true"/>
              </posted>                      
            </extenders>         
            <validators>
              <post>
                <required_validator target="Address.idfsCountry" property="Address.Country" label ="Farm.Address.idfsCountry"/>
                <required_validator target="Address.idfsRegion" property="Address.Region" label ="Farm.Address.idfsRegion"/>
                <required_validator target="Address.idfsRayon" property="Address.Rayon" label ="Farm.Address.idfsRayon"/>
              </post>
            </validators>
          
          <actions>
            <standard>
              <remove type="Create"/>
            </standard>
          </actions>
        </table>
    </tables>

</object>

